<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule State Configuration</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <header class="main-header">
        <div class="container">
            <h1>Schedule State Configuration</h1>
            <nav>
                <a href="index.html" class="nav-link">Dashboard</a>
                <a href="audit.html" class="nav-link">Data Audit</a>
                <a href="settings.html" class="nav-link active">Settings</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="settings-section">
            <h2>Manage Schedule States</h2>
            <p class="settings-description">
                Define schedule states that appear in your CSV files. Configure whether each state is paid, 
                its category, and whether it should be shown by default on the dashboard.
            </p>

            <div class="state-form-container">
                <form id="stateForm" class="state-form">
                    <div class="form-group">
                        <label for="stateName">State Name *</label>
                        <input type="text" id="stateName" required placeholder="e.g., Break, Meeting, Work">
                        <small>This must match exactly as it appears in the CSV file</small>
                    </div>

                    <div class="form-group">
                        <label for="stateCategory">Category *</label>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <select id="stateCategory" required style="flex: 1;">
                                <option value="">Select Category</option>
                            </select>
                            <button type="button" class="btn btn-secondary" id="addCategoryBtn" style="white-space: nowrap;">Add Category</button>
                        </div>
                        <small>Select an existing category or add a new one</small>
                    </div>

                    <div class="form-group">
                        <label for="stateGroup">Schedule State Group</label>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <select id="stateGroup" style="flex: 1;">
                                <option value="">Select Group (Optional)</option>
                            </select>
                            <button type="button" class="btn btn-secondary" id="addGroupBtn" style="white-space: nowrap;">Add Group</button>
                        </div>
                        <small>Select a group or add a new one</small>
                    </div>

                    <div class="form-group">
                        <label for="isPaid">Paid Status</label>
                        <select id="isPaid" required>
                            <option value="true">Paid</option>
                            <option value="false">Unpaid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isDefault">
                            <span>Show by default on dashboard</span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="saveStateBtn">Save State</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">Cancel</button>
                    </div>
                </form>
            </div>

            <div class="states-list-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Configured States</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" id="selectAllBtn">Select All</button>
                        <button type="button" class="btn btn-secondary" id="deselectAllBtn">Deselect All</button>
                        <button type="button" class="btn btn-secondary" id="exportStatesBtn">Export CSV</button>
                        <button type="button" class="btn btn-secondary" id="importStatesBtn">Import CSV</button>
                    </div>
                </div>

                <!-- Bulk Actions Toolbar -->
                <div id="bulkActionsToolbar" style="display: none; background-color: var(--background); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <strong style="color: var(--primary-color);" id="selectedCount">0 selected</strong>
                        <div style="flex: 1; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <select id="bulkCategory" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <option value="">Update Category...</option>
                            </select>
                            <select id="bulkGroup" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <option value="">Update Group...</option>
                            </select>
                            <select id="bulkPaidStatus" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <option value="">Update Paid Status...</option>
                                <option value="true">Set to Paid</option>
                                <option value="false">Set to Unpaid</option>
                            </select>
                            <select id="bulkDefault" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <option value="">Update Default...</option>
                                <option value="true">Show by Default</option>
                                <option value="false">Hide by Default</option>
                            </select>
                            <button type="button" class="btn btn-primary" id="applyBulkUpdateBtn">Apply Updates</button>
                            <button type="button" class="btn btn-delete" id="bulkDeleteBtn">Delete Selected</button>
                        </div>
                    </div>
                </div>

                <input type="file" id="importFileInput" accept=".csv" style="display: none;">

                <div id="statesList" class="states-list">
                    <!-- Dynamic state cards will be inserted here -->
                </div>
            </div>

            <div class="categories-section" style="margin-top: 3rem;">
                <h3>Manage Categories</h3>
                <p class="settings-description" style="margin-bottom: 1.5rem;">
                    Manage custom categories. Default categories (Break, Meeting, Work, Time Off, Training, Supervisor Time, Loan, Coaching, Other) cannot be deleted.
                </p>
                
                <div class="category-form-container" style="background-color: var(--background); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 2rem;">
                    <form id="categoryForm" style="display: flex; gap: 0.75rem; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="newCategoryName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">New Category Name</label>
                            <input type="text" id="newCategoryName" required placeholder="Enter category name" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </form>
                </div>

                <div class="categories-list-container">
                    <h4>Custom Categories</h4>
                    <div id="categoriesList" class="categories-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                        <!-- Dynamic category cards will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="groups-section" style="margin-top: 3rem;">
                <h3>Manage Schedule State Groups</h3>
                <p class="settings-description" style="margin-bottom: 1.5rem;">
                    Manage custom groups. Default groups (Meeting, Training and COACHING, OTHER DUTIES, PAID TIME OFF, SYSTEM, etc.) cannot be deleted.
                </p>
                
                <div class="group-form-container" style="background-color: var(--background); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 2rem;">
                    <form id="groupForm" style="display: flex; gap: 0.75rem; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="newGroupName" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">New Group Name</label>
                            <input type="text" id="newGroupName" required placeholder="Enter group name" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Group</button>
                    </form>
                </div>

                <div class="groups-list-container">
                    <h4>Custom Groups</h4>
                    <div id="groupsList" class="groups-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                        <!-- Dynamic group cards will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="dashboard-visibility-section" style="margin-top: 3rem;">
                <h3>Dashboard Visibility</h3>
                <p class="settings-description" style="margin-bottom: 1.5rem;">
                    Control which Schedule State Group dashboards are visible on the main dashboard page. 
                    Each group will have its own dashboard showing states in that group.
                </p>
                
                <div style="margin-bottom: 1.5rem;">
                    <button type="button" class="btn btn-secondary" id="autoAssignGroupsBtn">Auto-Assign Groups to Existing States</button>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary);">
                        Automatically assign groups to states based on their names. Only assigns to states that don't already have a group.
                    </small>
                </div>

                <div style="margin-bottom: 1.5rem; background-color: var(--background); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color);">
                    <label for="groupSelector" style="display: block; margin-bottom: 0.75rem; font-weight: 500;">
                        Select Schedule State Group:
                    </label>
                    <div style="display: flex; gap: 0.75rem; align-items: flex-end; flex-wrap: wrap;">
                        <select id="groupSelector" style="flex: 1; min-width: 250px; padding: 0.625rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                            <option value="">-- Select a Group to Manage --</option>
                        </select>
                        <button type="button" class="btn btn-primary" id="toggleSelectedGroupBtn" disabled>Toggle Visibility</button>
                        <button type="button" class="btn btn-secondary" id="showAllGroupsBtn">Show All</button>
                        <button type="button" class="btn btn-secondary" id="hideAllGroupsBtn">Hide All</button>
                    </div>
                    <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary);">
                        Select a group from the dropdown to quickly toggle its dashboard visibility, or use "Show All" / "Hide All" for bulk operations.
                    </small>
                </div>
                
                <div id="dashboardVisibilityList" class="dashboard-visibility-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <!-- Dynamic dashboard visibility controls will be inserted here -->
                </div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 Workforce Management Dashboard</p>
        </div>
    </footer>

    <script src="js/stateConfig.js"></script>
    <script>
        // Settings page specific script
        let editingStateId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('stateForm');
            const statesList = document.getElementById('statesList');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const categoryForm = document.getElementById('categoryForm');
            const categoriesList = document.getElementById('categoriesList');
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const stateCategorySelect = document.getElementById('stateCategory');

            // Populate category dropdown
            function populateCategories() {
                const categories = StateConfig.getAllCategories();
                stateCategorySelect.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    stateCategorySelect.appendChild(option);
                });
            }

            // Render custom categories
            function renderCategories() {
                const customCategories = StateConfig.getCustomCategories();
                categoriesList.innerHTML = '';

                if (customCategories.length === 0) {
                    categoriesList.innerHTML = '<p style="color: var(--text-secondary); font-style: italic; grid-column: 1 / -1;">No custom categories yet. Add one above.</p>';
                    return;
                }

                customCategories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'state-card';
                    card.style.padding = '1rem';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">${category}</span>
                            <button class="btn btn-small btn-delete" data-category="${category}">Delete</button>
                        </div>
                    `;
                    categoriesList.appendChild(card);
                });

                // Add delete event listeners
                document.querySelectorAll('#categoriesList .btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const categoryName = this.getAttribute('data-category');
                        if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                            try {
                                StateConfig.deleteCustomCategory(categoryName);
                                renderCategories();
                                populateCategories();
                                // If the deleted category was selected, clear selection
                                if (stateCategorySelect.value === categoryName) {
                                    stateCategorySelect.value = '';
                                }
                            } catch (error) {
                                alert(error.message);
                            }
                        }
                    });
                });
            }

            // Populate group dropdown
            function populateGroups() {
                const stateGroupSelect = document.getElementById('stateGroup');
                if (!stateGroupSelect) return;
                const groups = StateConfig.getAllGroups();
                stateGroupSelect.innerHTML = '<option value="">Select Group (Optional)</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    stateGroupSelect.appendChild(option);
                });
            }

            // Populate bulk group dropdown
            function populateBulkGroups() {
                const bulkGroupSelect = document.getElementById('bulkGroup');
                if (!bulkGroupSelect) return;
                const groups = StateConfig.getAllGroups();
                bulkGroupSelect.innerHTML = '<option value="">Update Group...</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    bulkGroupSelect.appendChild(option);
                });
            }

            // Render custom groups
            function renderGroups() {
                const groupsList = document.getElementById('groupsList');
                if (!groupsList) return;
                
                const customGroups = StateConfig.getCustomGroups();
                groupsList.innerHTML = '';

                if (customGroups.length === 0) {
                    groupsList.innerHTML = '<p style="color: var(--text-secondary); font-style: italic; grid-column: 1 / -1;">No custom groups yet. Add one above.</p>';
                    return;
                }

                customGroups.forEach(group => {
                    const card = document.createElement('div');
                    card.className = 'state-card';
                    card.style.padding = '1rem';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">${group}</span>
                            <button class="btn btn-small btn-delete" data-group="${group}">Delete</button>
                        </div>
                    `;
                    groupsList.appendChild(card);
                });

                // Add delete event listeners
                document.querySelectorAll('#groupsList .btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const groupName = this.getAttribute('data-group');
                        if (confirm(`Are you sure you want to delete the group "${groupName}"?`)) {
                            try {
                                StateConfig.deleteCustomGroup(groupName);
                                renderGroups();
                                populateGroups();
                                populateBulkGroups();
                                // If the deleted group was selected, clear selection
                                const stateGroupSelect = document.getElementById('stateGroup');
                                if (stateGroupSelect && stateGroupSelect.value === groupName) {
                                    stateGroupSelect.value = '';
                                }
                            } catch (error) {
                                alert(error.message);
                            }
                        }
                    });
                });
            }

            // Add category from dropdown button
            addCategoryBtn.addEventListener('click', function() {
                const categoryName = prompt('Enter new category name:');
                if (categoryName && categoryName.trim()) {
                    try {
                        StateConfig.addCustomCategory(categoryName.trim());
                        populateCategories();
                        renderCategories();
                        stateCategorySelect.value = categoryName.trim();
                        alert(`Category "${categoryName.trim()}" added successfully!`);
                    } catch (error) {
                        alert(error.message);
                    }
                }
            });

            // Add group from dropdown button
            const addGroupBtn = document.getElementById('addGroupBtn');
            addGroupBtn.addEventListener('click', function() {
                const groupName = prompt('Enter new group name:');
                if (groupName && groupName.trim()) {
                    try {
                        StateConfig.addCustomGroup(groupName.trim());
                        populateGroups();
                        renderGroups();
                        document.getElementById('stateGroup').value = groupName.trim();
                        alert(`Group "${groupName.trim()}" added successfully!`);
                    } catch (error) {
                        alert(error.message);
                    }
                }
            });

            // Add category from form
            categoryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const categoryName = document.getElementById('newCategoryName').value.trim();
                if (categoryName) {
                    try {
                        StateConfig.addCustomCategory(categoryName);
                        document.getElementById('newCategoryName').value = '';
                        populateCategories();
                        renderCategories();
                        alert(`Category "${categoryName}" added successfully!`);
                    } catch (error) {
                        alert(error.message);
                    }
                }
            });

            // Bulk update functions
            function getSelectedStateIds() {
                return Array.from(document.querySelectorAll('.state-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
            }

            function updateBulkActionsToolbar() {
                const selectedIds = getSelectedStateIds();
                const toolbar = document.getElementById('bulkActionsToolbar');
                const selectedCount = document.getElementById('selectedCount');
                
                if (selectedIds.length > 0) {
                    toolbar.style.display = 'block';
                    selectedCount.textContent = `${selectedIds.length} selected`;
                } else {
                    toolbar.style.display = 'none';
                }
            }

            // Select All / Deselect All
            document.getElementById('selectAllBtn').addEventListener('click', function() {
                document.querySelectorAll('.state-checkbox').forEach(cb => cb.checked = true);
                updateBulkActionsToolbar();
            });

            document.getElementById('deselectAllBtn').addEventListener('click', function() {
                document.querySelectorAll('.state-checkbox').forEach(cb => cb.checked = false);
                updateBulkActionsToolbar();
            });

            // Bulk update
            document.getElementById('applyBulkUpdateBtn').addEventListener('click', function() {
                const selectedIds = getSelectedStateIds();
                if (selectedIds.length === 0) {
                    alert('Please select at least one state to update.');
                    return;
                }

                const categoryValue = document.getElementById('bulkCategory').value;
                const groupValue = document.getElementById('bulkGroup') ? document.getElementById('bulkGroup').value : '';
                const paidStatusValue = document.getElementById('bulkPaidStatus').value;
                const defaultValue = document.getElementById('bulkDefault').value;

                if (!categoryValue && !groupValue && paidStatusValue === '' && defaultValue === '') {
                    alert('Please select at least one field to update.');
                    return;
                }

                let updated = 0;
                selectedIds.forEach(stateId => {
                    try {
                        const state = StateConfig.getState(stateId);
                        if (!state) return;

                        const updateData = {};
                        if (categoryValue) updateData.category = categoryValue;
                        if (groupValue) updateData.group = groupValue;
                        if (paidStatusValue !== '') updateData.isPaid = paidStatusValue === 'true';
                        if (defaultValue !== '') updateData.isDefault = defaultValue === 'true';

                        StateConfig.updateState(stateId, { ...state, ...updateData });
                        updated++;
                    } catch (error) {
                        console.error(`Error updating state ${stateId}:`, error);
                    }
                });

                // Clear selections
                document.getElementById('bulkCategory').value = '';
                if (document.getElementById('bulkGroup')) document.getElementById('bulkGroup').value = '';
                document.getElementById('bulkPaidStatus').value = '';
                document.getElementById('bulkDefault').value = '';
                document.querySelectorAll('.state-checkbox').forEach(cb => cb.checked = false);
                
                alert(`Successfully updated ${updated} state(s).`);
                renderStates();
                populateCategories();
                populateGroups();
                populateBulkGroups();
                renderDashboardVisibility();
                updateBulkActionsToolbar();
            });

            // Bulk delete
            document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
                const selectedIds = getSelectedStateIds();
                if (selectedIds.length === 0) {
                    alert('Please select at least one state to delete.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${selectedIds.length} state(s)?`)) {
                    return;
                }

                let deleted = 0;
                selectedIds.forEach(stateId => {
                    try {
                        StateConfig.deleteState(stateId);
                        deleted++;
                    } catch (error) {
                        console.error(`Error deleting state ${stateId}:`, error);
                    }
                });

                alert(`Successfully deleted ${deleted} state(s).`);
                renderStates();
                updateBulkActionsToolbar();
            });

            // Export states to CSV
            document.getElementById('exportStatesBtn').addEventListener('click', function() {
                const states = StateConfig.getAllStates();
                if (states.length === 0) {
                    alert('No states to export.');
                    return;
                }

                // Create CSV content
                const headers = ['Name', 'Category', 'Group', 'Paid', 'Default'];
                const rows = states.map(state => [
                    state.name,
                    state.category,
                    state.group || '',
                    state.isPaid ? 'Yes' : 'No',
                    state.isDefault ? 'Yes' : 'No'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `schedule_states_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Import states from CSV
            document.getElementById('importStatesBtn').addEventListener('click', function() {
                document.getElementById('importFileInput').click();
            });

            document.getElementById('importFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const csvContent = event.target.result;
                        const lines = csvContent.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            alert('CSV file must have at least a header row and one data row.');
                            return;
                        }

                        // Parse CSV (simple parser)
                        const parseCSVLine = (line) => {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            result.push(current.trim());
                            return result;
                        };

                        const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().replace(/"/g, ''));
                        const nameIndex = headers.findIndex(h => h.includes('name'));
                        const categoryIndex = headers.findIndex(h => h.includes('category'));
                        const groupIndex = headers.findIndex(h => h.includes('group'));
                        const paidIndex = headers.findIndex(h => h.includes('paid'));
                        const defaultIndex = headers.findIndex(h => h.includes('default'));

                        if (nameIndex === -1 || categoryIndex === -1) {
                            alert('CSV must have "Name" and "Category" columns.');
                            return;
                        }

                        let imported = 0;
                        let updated = 0;
                        let errors = [];

                        for (let i = 1; i < lines.length; i++) {
                            const row = parseCSVLine(lines[i]);
                            if (row.length < 2) continue;

                            const name = row[nameIndex].replace(/"/g, '');
                            const category = row[categoryIndex].replace(/"/g, '');
                            const group = groupIndex >= 0 ? (row[groupIndex] || '').replace(/"/g, '') : '';
                            const isPaid = paidIndex >= 0 ? (row[paidIndex] || '').toLowerCase().includes('yes') : true;
                            const isDefault = defaultIndex >= 0 ? (row[defaultIndex] || '').toLowerCase().includes('yes') : false;

                            if (!name || !category) continue;

                            try {
                                // Check if category exists, if not add it
                                const allCategories = StateConfig.getAllCategories();
                                if (!allCategories.includes(category)) {
                                    StateConfig.addCustomCategory(category);
                                }

                                // Check if group exists, if not add it
                                if (group) {
                                    const allGroups = StateConfig.getAllGroups();
                                    if (!allGroups.includes(group)) {
                                        StateConfig.addCustomGroup(group);
                                    }
                                }

                                // Check if state exists
                                const existing = StateConfig.getStateByName(name);
                                if (existing) {
                                    StateConfig.updateState(existing.id, { name, category, group, isPaid, isDefault });
                                    updated++;
                                } else {
                                    StateConfig.addState({ name, category, group, isPaid, isDefault });
                                    imported++;
                                }
                            } catch (error) {
                                errors.push(`${name}: ${error.message}`);
                            }
                        }

                        // Clear file input
                        e.target.value = '';

                        let message = `Import complete!\n- ${imported} new state(s) imported\n- ${updated} existing state(s) updated`;
                        if (errors.length > 0) {
                            message += `\n- ${errors.length} error(s):\n${errors.slice(0, 5).join('\n')}`;
                        }
                        alert(message);

                        renderStates();
                        populateCategories();
                        populateGroups();
                        populateBulkGroups();
                        renderCategories();
                        renderGroups();
                        renderDashboardVisibility();
                    } catch (error) {
                        alert(`Error importing CSV: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });

            // Populate bulk category dropdown
            function populateBulkCategories() {
                const bulkCategorySelect = document.getElementById('bulkCategory');
                const categories = StateConfig.getAllCategories();
                bulkCategorySelect.innerHTML = '<option value="">Update Category...</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    bulkCategorySelect.appendChild(option);
                });
            }

            // Add group from form
            const groupForm = document.getElementById('groupForm');
            if (groupForm) {
                groupForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const groupName = document.getElementById('newGroupName').value.trim();
                    if (groupName) {
                        try {
                            StateConfig.addCustomGroup(groupName);
                            document.getElementById('newGroupName').value = '';
                            populateGroups();
                            populateBulkGroups();
                            renderGroups();
                            alert(`Group "${groupName}" added successfully!`);
                        } catch (error) {
                            alert(error.message);
                        }
                    }
                });
            }

            // Populate group selector dropdown
            function populateGroupSelector() {
                const selector = document.getElementById('groupSelector');
                if (!selector) return;

                const allGroups = StateConfig.getAllGroups();
                selector.innerHTML = '<option value="">-- Select a Group to Manage --</option>';
                
                allGroups.forEach(groupName => {
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = groupName;
                    selector.appendChild(option);
                });
            }

            // Render dashboard visibility controls
            function renderDashboardVisibility() {
                const container = document.getElementById('dashboardVisibilityList');
                if (!container) return;

                const allGroups = StateConfig.getAllGroups();
                const visibility = StateConfig.getDashboardVisibility();
                
                container.innerHTML = '';

                if (allGroups.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1;">No groups available. Add schedule states with groups first.</p>';
                    return;
                }

                allGroups.forEach(groupName => {
                    const isVisible = visibility[groupName] !== false; // Default to true
                    const statesInGroup = StateConfig.getStatesByGroup(groupName);
                    const stateCount = statesInGroup.length;

                    const card = document.createElement('div');
                    card.className = 'state-card';
                    card.style.padding = '1rem';
                    card.style.border = isVisible ? '2px solid var(--primary-color)' : '1px solid var(--border-color)';
                    card.style.backgroundColor = isVisible ? 'var(--background)' : 'var(--surface)';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0;">${groupName}</h4>
                                <small style="color: var(--text-secondary);">${stateCount} state(s) in this group</small>
                            </div>
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" data-group="${groupName}" ${isVisible ? 'checked' : ''} style="cursor: pointer;">
                                <span>${isVisible ? 'Visible' : 'Hidden'}</span>
                            </label>
                        </div>
                    `;
                    container.appendChild(card);

                    // Add event listener
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        const group = this.getAttribute('data-group');
                        const visible = this.checked;
                        StateConfig.setDashboardVisibility(group, visible);
                        renderDashboardVisibility(); // Refresh to update styling
                        populateGroupSelector(); // Refresh selector to show current state
                    });
                });
            }

            // Toggle selected group visibility
            const toggleSelectedGroupBtn = document.getElementById('toggleSelectedGroupBtn');
            const groupSelector = document.getElementById('groupSelector');
            
            if (groupSelector && toggleSelectedGroupBtn) {
                groupSelector.addEventListener('change', function() {
                    const selectedGroup = this.value;
                    toggleSelectedGroupBtn.disabled = !selectedGroup;
                    
                    if (selectedGroup) {
                        const visibility = StateConfig.getDashboardVisibility();
                        const currentVisibility = visibility[selectedGroup] !== false; // Default to true
                        toggleSelectedGroupBtn.textContent = currentVisibility ? 'Hide Dashboard' : 'Show Dashboard';
                    } else {
                        toggleSelectedGroupBtn.textContent = 'Toggle Visibility';
                    }
                });

                toggleSelectedGroupBtn.addEventListener('click', function() {
                    const selectedGroup = groupSelector.value;
                    if (!selectedGroup) return;

                    const visibility = StateConfig.getDashboardVisibility();
                    const currentVisibility = visibility[selectedGroup] !== false; // Default to true
                    const newVisibility = !currentVisibility;

                    StateConfig.setDashboardVisibility(selectedGroup, newVisibility);
                    renderDashboardVisibility();
                    
                    // Update button text
                    toggleSelectedGroupBtn.textContent = newVisibility ? 'Hide Dashboard' : 'Show Dashboard';
                    
                    alert(`Dashboard for "${selectedGroup}" is now ${newVisibility ? 'visible' : 'hidden'}.`);
                });
            }

            // Show all groups
            const showAllGroupsBtn = document.getElementById('showAllGroupsBtn');
            if (showAllGroupsBtn) {
                showAllGroupsBtn.addEventListener('click', function() {
                    if (confirm('Show all dashboard groups?')) {
                        const allGroups = StateConfig.getAllGroups();
                        allGroups.forEach(group => {
                            StateConfig.setDashboardVisibility(group, true);
                        });
                        renderDashboardVisibility();
                        populateGroupSelector();
                        alert(`All ${allGroups.length} dashboard(s) are now visible.`);
                    }
                });
            }

            // Hide all groups
            const hideAllGroupsBtn = document.getElementById('hideAllGroupsBtn');
            if (hideAllGroupsBtn) {
                hideAllGroupsBtn.addEventListener('click', function() {
                    if (confirm('Hide all dashboard groups?')) {
                        const allGroups = StateConfig.getAllGroups();
                        allGroups.forEach(group => {
                            StateConfig.setDashboardVisibility(group, false);
                        });
                        renderDashboardVisibility();
                        populateGroupSelector();
                        alert(`All ${allGroups.length} dashboard(s) are now hidden.`);
                    }
                });
            }

            // Auto-assign groups button
            const autoAssignGroupsBtn = document.getElementById('autoAssignGroupsBtn');
            if (autoAssignGroupsBtn) {
                autoAssignGroupsBtn.addEventListener('click', function() {
                    if (confirm('This will automatically assign groups to all states that don\'t have a group assigned. Continue?')) {
                        try {
                            const updated = StateConfig.autoAssignGroupsToExistingStates();
                            alert(`Successfully assigned groups to ${updated} state(s).`);
                            renderStates();
                            renderDashboardVisibility();
                            populateGroups();
                            populateBulkGroups();
                            populateGroupSelector();
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                        }
                    }
                });
            }

            // Initialize
            populateCategories();
            populateGroups();
            populateBulkCategories();
            populateBulkGroups();
            populateGroupSelector();
            renderCategories();
            renderGroups();
            renderDashboardVisibility();

            function renderStates() {
                const states = StateConfig.getAllStates();
                statesList.innerHTML = '';

                if (states.length === 0) {
                    statesList.innerHTML = '<p class="no-states">No states configured yet. Add your first state above.</p>';
                    updateBulkActionsToolbar();
                    return;
                }

                states.forEach(state => {
                    const card = document.createElement('div');
                    card.className = 'state-card';
                    card.innerHTML = `
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <input type="checkbox" class="state-checkbox" data-id="${state.id}" style="margin-top: 0.25rem; cursor: pointer;">
                            <div style="flex: 1;">
                                <div class="state-card-header">
                                    <h4>${state.name}</h4>
                                    <div class="state-badges">
                                        <span class="badge badge-category">${state.category}</span>
                                        ${state.group ? `<span class="badge" style="background-color: #e0e7ff; color: #3730a3;">${state.group}</span>` : ''}
                                        <span class="badge ${state.isPaid ? 'badge-paid' : 'badge-unpaid'}">
                                            ${state.isPaid ? 'Paid' : 'Unpaid'}
                                        </span>
                                        ${state.isDefault ? '<span class="badge badge-default">Default</span>' : ''}
                                    </div>
                                </div>
                                <div class="state-card-actions">
                                    <button class="btn btn-small btn-edit" data-id="${state.id}">Edit</button>
                                    <button class="btn btn-small btn-delete" data-id="${state.id}">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    statesList.appendChild(card);
                });

                // Add checkbox event listeners
                document.querySelectorAll('.state-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateBulkActionsToolbar);
                });

                // Add event listeners
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const stateId = this.getAttribute('data-id');
                        editState(stateId);
                    });
                });

                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const stateId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this state?')) {
                            StateConfig.deleteState(stateId);
                            renderStates();
                        }
                    });
                });
            }

            function editState(stateId) {
                const state = StateConfig.getState(stateId);
                if (!state) return;

                editingStateId = stateId;
                document.getElementById('stateName').value = state.name;
                document.getElementById('stateCategory').value = state.category;
                document.getElementById('stateGroup').value = state.group || '';
                document.getElementById('isPaid').value = state.isPaid.toString();
                document.getElementById('isDefault').checked = state.isDefault;
                document.getElementById('saveStateBtn').textContent = 'Update State';
                cancelBtn.style.display = 'inline-block';
                document.getElementById('stateName').focus();
            }

            function resetForm() {
                editingStateId = null;
                form.reset();
                populateGroups(); // Reset group dropdown
                document.getElementById('saveStateBtn').textContent = 'Save State';
                cancelBtn.style.display = 'none';
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const categoryValue = document.getElementById('stateCategory').value.trim();
                
                // If category doesn't exist, add it as custom category first
                const allCategories = StateConfig.getAllCategories();
                if (categoryValue && !allCategories.includes(categoryValue)) {
                    try {
                        StateConfig.addCustomCategory(categoryValue);
                        populateCategories();
                        renderCategories();
                    } catch (error) {
                        alert(`Error adding category: ${error.message}`);
                        return;
                    }
                }

                const groupValue = document.getElementById('stateGroup').value.trim();
                
                // If group doesn't exist and is provided, add it as custom group
                if (groupValue) {
                    const allGroups = StateConfig.getAllGroups();
                    if (!allGroups.includes(groupValue)) {
                        try {
                            StateConfig.addCustomGroup(groupValue);
                            populateGroups();
                            renderGroups();
                        } catch (error) {
                            alert(`Error adding group: ${error.message}`);
                            return;
                        }
                    }
                }

                const stateData = {
                    name: document.getElementById('stateName').value.trim(),
                    category: categoryValue,
                    group: groupValue || '',
                    isPaid: document.getElementById('isPaid').value === 'true',
                    isDefault: document.getElementById('isDefault').checked
                };

                try {
                    if (editingStateId) {
                        StateConfig.updateState(editingStateId, stateData);
                    } else {
                        StateConfig.addState(stateData);
                    }

                    resetForm();
                    renderStates();
                    populateCategories(); // Refresh in case category was new
                    populateGroups(); // Refresh in case group was new
                    populateBulkGroups(); // Refresh bulk dropdown
                    renderDashboardVisibility(); // Refresh dashboard visibility
                } catch (error) {
                    alert(`Error saving state: ${error.message}`);
                }
            });

            cancelBtn.addEventListener('click', resetForm);

            // Initial render
            renderStates();
        });
    </script>
</body>
</html>

